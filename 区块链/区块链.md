nodejs 开发迷你区块链

区块链：分布式数据存储 点对点传输 共识机制 加密算法等计算机技术的新型应用模式

功能： 挖矿 非对称加密 转账 p2p网络  众筹  ipfs视频  问答

技术栈  nodejs  以太坊solidity  

数据库后端之类的放在区块链上运行

前端用react  与区块链交互用web3.js  这是以太坊官方的sdk  浏览器可以直接访问到内容  存储视频文件音频图片的时候，存到ipfs上  把hash值存到以太网上



nodejs开发迷你区块链基于以太坊开发DApp

测试链搭建  IPFS存储文件 钱包 设计思路 代码测试 部署

以太坊solidity也是强类型语言

# 基本概念：

## 去中心化

服务器是中心，a和b聊天，数据发服务器，服务器接收到后再转发给b。  

去中心化： 点对点通信，不管是参与人员还是群众，每个人都有记账权，可以将账本信息对外发送，接收到账本的人，辅助账本信息的传播，这个传播过程并未经过一个中心的服务器，比特币就采用这种通信方式。

## 账本隐私和快速对账

### 简介

一个岛上人用红色石头交易，风暴将石头全部卷走，此时每个人的脑子里都有其拥有的石头个数，他们把这些个数形成一个账本，比特币也是这样的账本

因为每个人都有记账权，记得最快最准的那个人就先去广播出这一笔交易，广播成功，god会给这个人一笔奖励。

因为广播是实名广播出去的，所以每个人都知道这笔交易

也因为信息对所有人可见，所以就有可能被劫持，此时就有了账本保护隐私

### 比特币如何保护账本隐私？

比特币系统利用hash算法对交易信息（账户，交易内容）进行加密，保护隐私

### hash算法对账

账本一a+1，b-1，账本二c+5，d-5

加密后的hash值一致 说明账本信息没错  不同则说明账本存在差异



## 比特币的分叉

a在b买了个牛，用了一个红色石头，但是c此时不知道a用石头消费了一头牛。  此时a给c说我给你一个红色石头，让c把他拥有的羊给他，但此时c不知a已经把石头花出去了，他就同意了

然后，a就这个交易信息记录账本，并立马广播

此时，岛上流传两个信息，a用红色石头买牛，a用石头买羊，账本不同，这就是分叉，第一笔交易是真实的

a的第二笔买羊交易要成功需要挂在第二个节点后面，就相当于把自己的钱重复花出去，这就是比特币中的双花问题，容易导致分叉

单笔交易大小250个字节左右，每个区块1m  单秒交易7比，太小，想要当大容量矿工，就要扩容，扩容就意味着系统更新

新矿工挖出8m区块，接到1mb后面，在挖出8m接到8

m后面，旧矿工挖出1m接到这个后面，形成一个链条，也就是比特币现金。而旧矿工未更新软件，也就只能挖出1m的区块，所以他们生成的区块和新矿工不在一起，也就是比特币。

只要旧矿工不更新软件，分支就不能合并，也叫硬分叉，而软分叉是可以合并的

## 分叉的应对，账本一致性

比特币规定最长链条为可信任的链条

## 矿工和记账权和链条

比特币中的矿工： 创造区块，使链条增长

虽然每个人都能记账，但并不是每个人都有记账权力，系统抛出一道计算量很大的数学题，系统内的计算机开始比赛，争取又快又准的算出这个数学题的答案，胜出的计算机取得记账权，胜出的计算机将交易信息打造成新的区块（标号），然后这个计算机将区块信息广播出去。然后系统会给这个计算机一笔奖励

比的是计算力，不是智力，比特币规定最长链条为可信任的链条，所以一个计算机要不断拿到记账权，不断生成新的区块，延长链条。

算力越强，主链延出的分叉链，就能不断更新，也能保证可信任度。从这里看主链是由少数人维护，分叉链是个人维护。

### 账本的正确性

在比特币系统里面，想要伪造的账本成为主链，必须要和比特币系统其余的人比拼算力，只有长时间保持算力优先，才有伪造账本的可能，但保持长时间算力优先，难度巨大，有可能成本高于伪造获利的成本，正是通过这种手段保证账本的正确性

### 记账权获取方式

简称pow算法 。proof of work

###  nonce值挖矿次数和挖矿

拿到区块数据（账本交易信息），生成hash值，此时比特币系统也给一个hash值，比较小于系统给的则是找到符合条件的hash值得，不符合则再次计算，然后nonce值++。 计算的次数也就是挖矿的次数，称为nonce值。找到目标hash的过程称为挖矿，这一套流程的算法叫做工作量证明算法

## **总结**

**比特币不是一种货币，而是一种分布式账务系统。**账本在每个参与者的电脑上备份，并且实时同步和对账；账本记录了一定数量的比特币交易的过程，每次记录下的交易过程和结果都会广播到网络，让所有节点都保持一致

**比特币系统采用了去中心化的方式。**不是没有中心, 而是中心不停变化，每一次中心由节点竞争而得出记账权，记录交易打造成新的区块（每一笔交易中挖矿成功的矿工就是中心）

**区块链1.0技术**，也就是比特币系统（所有比特币中应用到的技术）：分布式数据存储，点对点传输，共识机制（POW），加密算法



# 以太坊

## 简介

比特币让贸易简单，但也有不足，比如交易速度慢，挖币pow算法  耗电，也仅仅完成比特币的去中心化，有时候要拿到自己的钱需要打关系，因此开发出了出现了以太坊，现实中的业务也出现了去中心化

以太坊改进： 比特币的挖矿很慢，以太坊让挖币更快

以太坊的算法是pos+pow算法，逐渐向pos算法过度。

以太坊引进了智能合约，相当于之前合同是在纸质合同，现在承诺合同则变成了一串不可修改的代码，避免了纠纷。

合约的代码在以太坊上是受监督的  ，里面的规则不可修改，一旦违反就给出处罚

**定义**： **以太坊是运行在计算机网络上的一个软件，他确保数据以及智能合约的小程序可以在没有中心协调者的情况下，被所有网路中的计算机复制和处理。**

智能合约的小程序上传到以太坊平台，是不能更新或者下架的

以太坊的愿景是创建一个无法停止，抗屏蔽和自我维持的去中心化世界计算机





## metamask软件插件 

注册以太坊钱包，账户名下的hash值相当于银行卡号，里面的货币是以太币  基于比特币

写入数据要交手续费，也叫汽油费，费用大小根据网络拥堵状况，油钱给的少写入失败且不退，给的多了会退  **计算公式：油单价Gas Price * Gas Limit油数量**

## 智能合约

一段跑在以太坊系统中的代码合同。

规则明确，不受主观因素影响的业务。

以太坊中查看智能合约不需要支付手续费，但修改智能合约需要支付

## 以太坊中的Gost协议

多个矿工挖出多个区块，算力大，位置优越的区块更容易在网络中传播，出现区亏块分叉时，其更容易成为主链。这种情况下算力小的节点就很小拿到奖励。  这样下来算力小的矿工挖出的区块就不想进行合并到其他链。

为了推进更快的分叉合并，以太坊用了goast协议。

**目的：尽快招安分叉区块/分支链的尽快合并，以促成统一的区块链**

以太坊规定每个区块最多包含2个对叔父区块的奖励，以招安分支链的区块，以太坊会给在每次主链矿工的下一代新区块产生时，分出2份奖励来招安，奖励2份7/8的出块奖励（每次出块奖励是3个以太币）；同时，招安的主链上的区块，也可以得到2*（1/32）的出块奖励；

每隔一代，区块奖励就会减少：最近的一代uncle区块，可以得到7/8的出块奖励作为招安；再隔远一层的uncle区块，则是6/8的出块奖励作为招安；间隔8代及以后的uncle区块，则不会得到任何出块奖励。uncle区块的后续分支链上不会得到任何奖励，以激励其尽快进行合并

## 以太坊的挖矿算法

### pos算法

> pow算法是钱转给矿机，矿机比拼算力然后转换成收益
>
> pos算法又称为proof of stake 权益证明，这种挖矿方式又叫虚拟挖矿
>
> 目前是pos和pow混合使用

工作形式： 钱转成虚拟货币，在挖矿的时候进行下注，矿工a投了5枚，b投了10枚，投入的货币又称为保证金，它决定了挖矿的难度。a和b在挖到100个区块时候，a投入2个 ，b投入9个，那么这个区块对b更容易。

但是每一个区块的产出，比拼的不是矿工所有的货币，而是每次挖矿挖出来的保证金，保证金挖矿使用后会锁定，一定次数后解冻才可以重复使用。

还是上面的例子，a投入2个后还剩3枚，a投入的2枚被锁定一定次数内不能使用，b投入了9枚还剩1枚，9枚被锁定一定次数不可使用。那么继续投下去在新的区块，a胜出的几率就大于b胜出的几率

### casper协议

casper协议最重要的一块是引入了校验者validator，作用是投票选举区块是否能成为主链上的区块。这个区块是由pow算法挖矿得出。

两边下注投票 会扣保证金  不投票不作为 也会扣保证金

超过3分之2，投票的链条成为主链
